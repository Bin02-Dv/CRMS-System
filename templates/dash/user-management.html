{% extends "base.html" %}

{% load static %}
{% block content %}
 <!-- User Management Section -->
<section id="user-management" class="page-section section-3d">
    <h1 class="text-2xl font-bold mb-4">User Management</h1>
        <div class="mb-4">
        <button id="open-user-modal" class="bg-blue-600 text-white px-4 py-2 rounded card-3d" data-role="admin">Add New User</button>
    </div>
    <table class="w-full bg-white rounded shadow card-3d">
        <thead>
            <tr class="bg-gray-200">
                <th class="p-2">Full Name</th>
                <th class="p-2">Phone Number</th>
                <th class="p-2">Email</th>
                <th class="p-2">Role</th>
                <th class="p-2">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if all_users %}
            {% for user in all_users %}
            <tr>
                <td class="p-2">{{user.full_name}}</td>
                <td class="p-2">{{user.phone_number}}</td>
                <td class="p-2">{{user.email}}</td>
                <td class="p-2">{{user.role}}</td>
                <td class="p-2"><a href="#" class="text-blue-600">Edit Role</a></td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
                <td class="p-2">No users yet!</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</section>

<!-- User Registration Modal -->
<div id="user-registration-modal" class="modal">
    <div class="modal-content card-3d">
        <h2 class="text-lg font-bold mb-4">Register New User</h2>
        <form id="user-registration-form" method='POST' class="space-y-4">
            {% csrf_token %}
            <div>
                <label class="block text-sm font-medium text-gray-700">Full Name</label>
                <input type="text" name="full_name" id="user-fullname" class="border p-2 w-full rounded" placeholder="Enter full name" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Phone Number</label>
                <input type="tel" id="user-phone" name="phone_number" class="border p-2 w-full rounded" placeholder="08012345678" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="user-email" name="email" class="border p-2 w-full rounded" placeholder="Enter email" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="user-password" name="password" class="border p-2 w-full rounded" placeholder="Enter password" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Confirm Password</label>
                <input type="password" id="user-password" name="confirm_password" class="border p-2 w-full rounded" placeholder="Confirm password" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Role</label>
                <select id="user-role" name="role" class="border p-2 w-full rounded" required>
                    <option value="admin">Admin</option>
                    <option value="branch-manager">Branch Manager</option>
                    <option value="credit-officer">Credit Officer</option>
                    <option value="loan-officer">Loan Officer</option>
                    <option value="teller">Teller</option>
                </select>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" id="close-user-modal" class="bg-gray-600 text-white px-4 py-2 rounded card-3d">Cancel</button>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded card-3d">Register</button>
            </div>
        </form>
    </div>
</div>

 <script src="{% static 'js/jquery-3.5.1.js' %}"></script>

    <script>

        $(document).on('submit', '#user-registration-form', function (e){
            e.preventDefault();
            var m_success = $(".success");
            var m_error = $(".error");
            var m_info = $(".info");
            var m_text = $(".message");

            var formData = new FormData(this);
            var loader = document.querySelector(".loader-container");

            loader.classList.remove("hide-loader");
            $.ajax({
                type: 'POST',
                url: "/user-management/",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response){
                    var success = response['success'];
                    if(success){
                        m_success.show();
                        m_error.hide();
                        m_info.hide();

                        m_text.html('');
                        m_text.append(response['message']);
                        m_text.append("Loading....");

                        loader.classList.add("hide-loader");

                        setTimeout(() => {
                            $(".toast").fadeOut();
                        }, 5000);

                        window.location.href = "/user-management//";
                    }else{
                        m_error.show();
                        m_success.hide();
                        m_info.hide();

                        m_text.html('');
                        m_text.append(response['message']);
                        loader.classList.add("hide-loader");

                        setTimeout(() => {
                            $(".toast").fadeOut();
                        }, 5000);
                    }

                }
            });
        });
    </script>

<script>

    // Modal handling
        const userModal = document.getElementById('user-registration-modal');
        const openUserModalBtn = document.getElementById('open-user-modal');
        const closeUserModalBtn = document.getElementById('close-user-modal');
        const userForm = document.getElementById('user-registration-form');

        openUserModalBtn.addEventListener('click', () => {
            userModal.style.display = 'flex';
        });

        closeUserModalBtn.addEventListener('click', () => {
            userModal.style.display = 'none';
            userForm.reset();
        });

        // Close modal when clicking outside
        userModal.addEventListener('click', (e) => {
            if (e.target === userModal) {
                userModal.style.display = 'none';
                userForm.reset();
            }
        });

</script>
{% endblock %}