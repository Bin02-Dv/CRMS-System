{% extends "base.html" %}

{% load static %}
{% load humanize %}
{% block content %}
<!-- Loan Management Section -->
<section id="loan-management" class="page-section section-3d">
    <h1 class="text-2xl font-bold mb-4">Loan Management</h1>
    {% if current_user.role == 'admin' %}
    <div class="mb-4">
        <button id="open-loan-modal" class="bg-blue-600 text-white px-4 py-2 rounded card-3d" data-role="customer-service,loan-officer,admin">New Loan Application</button>
    </div>
    <table class="w-full bg-white rounded shadow card-3d">
        <thead>
            <tr class="bg-gray-200">
                <th class="p-2">Customer</th>
                <th class="p-2">Loan Type</th>
                <th class="p-2">Amount</th>
                <th class="p-2">Status</th>
                <th class="p-2">Due Date</th>
                <th class="p-2">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if loans %}
                {% for loan in loans %}
                <tr>
                    <td class="p-2">{{loan.customer.full_name}}</td>
                    <td class="p-2">{{loan.loan_type}}</td>
                    <td class="p-2">₦{{loan.loan_amount|floatformat:2|intcomma}}</td>
                    <td class="p-2">{{loan.status|capfirst}}</td>
                    <td class="p-2">{{loan.due_date}}</td>
                    {% if loan.status != "approved" %}
                    <td class="p-2"><a href="/approve-loan/{{loan.id}}" class="text-blue-600">Approve Loan</a></td>
                    {% else %}
                    <td class="p-2"><a href="#" class="text-green-600">Approved</a></td>
                    {% endif %}
                </tr>
                {% endfor %}
            {% else %}
            <tr>
                <td class="p-2">No loans yet!</td>
            </tr>
            {% endif %}
        </tbody>
    </table>
    {% endif %}
    <div class="mt-4 bg-white p-4 rounded shadow card-3d">
        <h2 class="text-lg mb-2">Loan Repayment Tracking</h2>
        <form id="repayment" method="POST">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block">Customer</label>
                    <select class="border p-2 w-full rounded" name="customer_id" id="customer_id">
                        {% if loans %}
                        {% for loan in loans %}
                        <option value="{{loan.customer.id}}">{{loan.customer.full_name}}</option>
                        {% endfor %}
                        {% else %}
                        <option>No Customers registered for loan yet!!</option>
                        {% endif %}
                    </select>
                </div>
                <div>
                    <label class="block">Payment Amount</label>
                    <input type="number" name="payment_amount" id="payment_amount" class="border p-2 w-full rounded" placeholder="Enter payment (₦)">
                </div>
            </div>
        </form>
        <p id="repayment-status" class="mt-2 text-gray-700"></p>
        <button id="recordPaymentBtn" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded card-3d">Record Payment</button>
    </div>

    <!-- New Loan Application Modal -->
    <div id="loan-application-modal" class="modal">
        <div class="modal-content card-3d">
            <h2 class="text-lg font-bold mb-4">New Loan Application</h2>
            <form id="loan-application-form" class="space-y-4" method="POST">
                {% csrf_token %}
                <div>
                    <label class="block text-sm font-medium text-gray-700">Customer</label>
                    <select id="loan-customer" name="customer" class="border p-2 w-full rounded" required>
                        <option value="">Select customer</option>
                        {% if customers %}
                        {% for customer in customers %}
                        <option value="{{customer.id}}">{{customer.full_name}}</option>
                        {% endfor %}
                        {% else %}
                        <option value="">No Customers Yet!</option>
                        {% endif %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Loan Type</label>
                    <select id="loan-type" name="loan_type" class="border p-2 w-full rounded" required>
                        <option value="">Select loan type</option>
                        <option value="Microloan">Microloan</option>
                        <option value="SME Loan">SME Loan</option>
                        <option value="Personal Loan">Personal Loan</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Amount Requested (₦)</label>
                    <input type="number" name="loan_amount" id="loan-amount" class="border p-2 w-full rounded" placeholder="Enter amount" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Repayment Period (Months)</label>
                    <input type="number" name="loan_period" id="loan-period" class="border p-2 w-full rounded" placeholder="Enter months" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Interest Rate (%)</label>
                    <input type="number" name="interest_rate" step="0.1" id="loan-interest" class="border p-2 w-full rounded" placeholder="Enter rate" required>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="close-loan-modal" class="bg-gray-600 text-white px-4 py-2 rounded card-3d">Cancel</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded card-3d">Submit Application</button>
                </div>
            </form>
        </div>
    </div>
</section>

<script src="{% static 'js/jquery-3.5.1.js' %}"></script>

    <script>

        $(document).on('submit', '#loan-application-form', function (e){
            e.preventDefault();
            var m_success = $(".success");
            var m_error = $(".error");
            var m_info = $(".info");
            var m_text = $(".message");

            var formData = new FormData(this);
            var loader = document.querySelector(".loader-container");

            loader.classList.remove("hide-loader");
            $.ajax({
                type: 'POST',
                url: "/loan-management/",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response){
                    var success = response['success'];
                    if(success){
                        m_success.show();
                        m_error.hide();
                        m_info.hide();

                        m_text.html('');
                        m_text.append(response['message']);
                        m_text.append("Loading....");

                        loader.classList.add("hide-loader");

                        setTimeout(() => {
                            $(".toast").fadeOut();
                        }, 5000);

                        window.location.href = "/loan-management/";
                    }else{
                        m_error.show();
                        m_success.hide();
                        m_info.hide();

                        m_text.html('');
                        m_text.append(response['message']);
                        loader.classList.add("hide-loader");

                        setTimeout(() => {
                            $(".toast").fadeOut();
                        }, 5000);
                    }

                }
            });
        });
    </script>

    <script>
        document.getElementById("recordPaymentBtn").addEventListener("click", function() {
            let form = document.getElementById("repayment");
            let customerId = document.getElementById("customer_id").value;
            let paymentAmount = document.getElementById("payment_amount").value;
            let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            var m_success = $(".success");
            var m_error = $(".error");
            var m_info = $(".info");
            var m_text = $(".message");

            var loader = document.querySelector(".loader-container");

            loader.classList.remove("hide-loader");

            fetch("/repayment/", {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrfToken,
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `customer_id=${customerId}&payment_amount=${paymentAmount}`
            })
            .then(response => response.json())
            .then(data => {
                let statusBox = document.getElementById("repayment-status");
                if (data.success) {
                    statusBox.innerHTML = `✅ ${data.message} <br> Balance: ₦${data.balance} | Next Due: ${data.next_due}`;
                    statusBox.classList.add("text-green-600");

                    m_success.show();
                    m_error.hide();
                    m_info.hide();

                    m_text.html('');
                    m_text.append(`✅ ${data.message} <br> Balance: ₦${data.balance} | Next Due: ${data.next_due}`);
                    m_text.append("Loading....");

                    loader.classList.add("hide-loader");
                } else {
                    statusBox.innerHTML = `❌ ${data.message}`;
                    statusBox.classList.add("text-red-600");
                    m_error.show();
                    m_success.hide();
                    m_info.hide();

                    m_text.html('');
                    m_text.append(`❌ ${data.message}`);
                    loader.classList.add("hide-loader");
                }
            })
            .catch(error => console.error("Error:", error));
        });
    </script>

<script>

    // Modal handling
    const loanModal = document.getElementById('loan-application-modal');
    const openLoanModalBtn = document.getElementById('open-loan-modal');
    const closeLoanModalBtn = document.getElementById('close-loan-modal');
    const loanForm = document.getElementById('loan-application-form');

    openLoanModalBtn.addEventListener('click', () => {
        loanModal.style.display = 'flex';
    });

    closeLoanModalBtn.addEventListener('click', () => {
        loanModal.style.display = 'none';
        loanForm.reset();
    });

    loanModal.addEventListener('click', (e) => {
        if (e.target === loanModal) {
            loanModal.style.display = 'none';
            loanForm.reset();
        }
    });
</script>
{% endblock %}