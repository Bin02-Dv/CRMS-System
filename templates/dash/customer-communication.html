{% extends "base.html" %}

{% load static %}
{% block content %}
<!-- Customer Communication Section -->
<section id="communication" class="page-section section-3d">
    <h1 class="text-2xl font-bold mb-4">Customer Communication</h1>
    <div class="mb-4 flex space-x-2">
        <select id="channel" class="border p-2">
            <option value="sms">SMS</option>
            <option value="email">Email</option>
        </select>
        <textarea id="messageBox" class="border p-2 flex-1 rounded" placeholder="Write your message..."></textarea>
        <button id="sendBtn" class="bg-blue-600 text-white px-4 py-2 rounded card-3d">Send Message</button>
    </div>

    <div class="bg-white p-4 rounded shadow card-3d">
        <h2 class="text-lg mb-2">Message Templates</h2>
        <ul class="list-disc pl-5">
            <li>
                <button class="template-btn" data-template="Dear [Name], your loan payment of ₦[Amount] is due on [Date].">
                    Loan Repayment Reminder
                </button>
            </li>
            <li>
                <button class="template-btn" data-template="Congratulations [Name], your loan of ₦[Amount] has been approved!">
                    Loan Approval
                </button>
            </li>
        </ul>
    </div>

    <div class="mt-4 bg-white p-4 rounded shadow card-3d">
        <h2 class="text-lg mb-2">Recent Communications</h2>
        <div id="recentLogs"></div>
    </div>
</section>

<script src="{% static 'js/jquery-3.5.1.js' %}"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const messageBox = document.getElementById("messageBox");
    const channel = document.getElementById("channel");
    const sendBtn = document.getElementById("sendBtn");
    const recentLogs = document.getElementById("recentLogs");

    document.querySelectorAll(".template-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            messageBox.value = btn.dataset.template;
        });
    });

    // Extract name, amount, and date using regex
    function extractDetails(text) {
        const nameMatch = text.match(/Dear\s+([A-Za-z\s]+)/i);
        const amountMatch = text.match(/₦\s?([\d,]+)/);
        const dateMatch = text.match(/(\d{1,2}\/\d{1,2}\/\d{4})/);

        return {
            customer: nameMatch ? nameMatch[1].trim() : null,
            amount: amountMatch ? amountMatch[1].replace(/,/g, "") : null,
            date: dateMatch ? dateMatch[1] : null,
        };
    }

    sendBtn.addEventListener("click", async () => {
        const msg = messageBox.value.trim();
        const type = channel.value;

        var m_success = $(".success");
        var m_error = $(".error");
        var m_info = $(".info");
        var m_text = $(".message");
        var loader = document.querySelector(".loader-container");

        loader.classList.remove("hide-loader");

        if (!msg) {
            m_error.show();
            m_success.hide();
            m_info.hide();

            m_text.html('');
            m_text.append("Message cannot be empty!");
            loader.classList.add("hide-loader");
        }else{
            // Extract info
            const details = extractDetails(msg);

            const response = await fetch("/api/send-message/", {
                method: "POST",
                headers: { 
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    channel: type,
                    message: msg,
                    customer: details.customer,
                    amount: details.amount,
                    date: details.date
                })
            });

            const data = await response.json();

             const logText = `${type.toUpperCase()} sent to ${data.customer} (₦${Number(data.amount).toLocaleString()}): "${data.message}" on ${data.date}`;

            const log = document.createElement("p");
            m_success.show();
            m_error.hide();
            m_info.hide();

            m_text.html('');
            m_text.append(logText);
            m_text.append("Loading....");
            loader.classList.add("hide-loader");
            log.textContent = logText;
            recentLogs.prepend(log);

            savedLogs.unshift(logText);
            localStorage.setItem("logs", JSON.stringify(savedLogs));


            messageBox.value = "";
        }
    });
});
</script>
{% endblock %}